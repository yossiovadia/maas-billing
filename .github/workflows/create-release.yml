# Create Release Workflow
#
# This workflow creates a release following the data-science-pipelines-operator pattern:
#   1. Creates a release branch (e.g., v1.x) from main
#   2. Updates kustomization files and MAAS_REF references on the release branch
#   3. Creates and pushes the release tag from the release branch
#   4. Builds and pushes the maas-api image
#   5. Deploys versioned documentation
#
# Usage:
#   1. Go to Actions > Create Release > Run workflow
#   2. Enter the tag (e.g., v1.0.0)
#   3. Optionally enable "Allow overwriting existing tag" (only for pre-release iterations)
#   4. Optionally enable "Create GitHub release"
#
# The workflow will:
#   - Extract minor version (e.g., v1.0.0 -> v1.x)
#   - Create/update release branch (e.g., v1.x)
#   - Update files on the release branch
#   - Create tag from the release branch
#   - Build image and deploy docs

name: Create Release
run-name: Create Release ${{ inputs.tag }}

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g., v1.0.0)'
        required: true
        type: string
      allow_tag_overwrite:
        description: 'Allow overwriting existing tag (use only for pre-release iterations)'
        required: false
        type: boolean
        default: false
      create_release:
        description: 'Create GitHub release'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  actions: read

env:
  MAAS_REPOSITORY: models-as-a-service
  GH_USER_NAME: github-actions[bot]
  GH_USER_EMAIL: github-actions[bot]@users.noreply.github.com

jobs:
  prepare-release:
    name: Prepare Release
    runs-on: ubuntu-latest
    outputs:
      version_tag: ${{ steps.set_vars.outputs.version_tag }}
      minor_release_branch: ${{ steps.set_vars.outputs.minor_release_branch }}
      minor_version: ${{ steps.set_vars.outputs.minor_version }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "${{ env.GH_USER_NAME }}"
          git config user.email "${{ env.GH_USER_EMAIL }}"

      - name: Set version variables
        id: set_vars
        run: |
          TAG="${{ inputs.tag }}"
          # Extract minor version (e.g., v1.0.0 -> 1.0 -> v1.x)
          if [[ "$TAG" =~ ^v?([0-9]+)\.([0-9]+)\. ]]; then
            MAJOR="${BASH_REMATCH[1]}"
            MINOR="${BASH_REMATCH[2]}"
            MINOR_VERSION="$MAJOR.$MINOR"
            MINOR_BRANCH="v$MINOR_VERSION.x"
          else
            # Fallback: use tag as-is for non-standard versions
            MINOR_VERSION="${TAG#v}"
            MINOR_BRANCH="release-$TAG"
          fi
          
          echo "version_tag=$TAG" >> $GITHUB_OUTPUT
          echo "minor_version=$MINOR_VERSION" >> $GITHUB_OUTPUT
          echo "minor_release_branch=$MINOR_BRANCH" >> $GITHUB_OUTPUT
          
          echo "Release tag: $TAG"
          echo "Minor version: $MINOR_VERSION"
          echo "Release branch: $MINOR_BRANCH"

      - name: Validate tag format
        run: |
          TAG="${{ inputs.tag }}"
          if [[ ! "$TAG" =~ ^v?[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9]+(\.[a-zA-Z0-9]+)*)?$ ]]; then
            echo "Warning: Tag '$TAG' doesn't follow semantic versioning format (v1.0.0)"
            exit 1
          fi

  create-release-branch:
    name: Create Release Branch
    runs-on: ubuntu-latest
    needs: prepare-release
    outputs:
      version_tag: ${{ needs.prepare-release.outputs.version_tag }}
      minor_release_branch: ${{ needs.prepare-release.outputs.minor_release_branch }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "${{ env.GH_USER_NAME }}"
          git config user.email "${{ env.GH_USER_EMAIL }}"

      - name: Create or update release branch
        run: |
          BRANCH="${{ needs.prepare-release.outputs.minor_release_branch }}"
          
          # Check if branch exists (use exact ref path to avoid matching v1.0.x-test when looking for v1.0.x)
          if git ls-remote --exit-code --heads origin "refs/heads/$BRANCH" &>/dev/null; then
            echo "Release branch $BRANCH already exists, checking it out"
            git fetch origin "$BRANCH"
            git checkout -b "$BRANCH" "origin/$BRANCH" || git checkout "$BRANCH"
            # Attempt to merge main, but don't fail if already up-to-date
            if ! git merge main --no-edit; then
              # Check if merge failed due to conflicts vs already up-to-date
              if git diff --name-only --diff-filter=U | grep -q .; then
                echo "❌ Merge conflicts detected. Please resolve manually."
                exit 1
              fi
              echo "Branch is already up to date with main"
            fi
          else
            echo "Creating new release branch $BRANCH from main"
            git checkout -b "$BRANCH" main
          fi

      - name: Update kustomization files with new tag
        run: |
          chmod +x .github/scripts/update-kustomize-tag.sh
          .github/scripts/update-kustomize-tag.sh "${{ needs.prepare-release.outputs.version_tag }}"

      - name: Update MAAS_REF references
        run: |
          chmod +x .github/scripts/update-maas-ref.sh
          .github/scripts/update-maas-ref.sh "${{ needs.prepare-release.outputs.version_tag }}"

      - name: Commit and push release branch
        run: |
          git add deployment/base/maas-api/kustomization.yaml
          git add maas-api/deploy/overlays/dev/kustomization.yaml || true
          git add maas-api/deploy/overlays/odh/params.env || true
          git add docs/ scripts/ || true
          
          if ! git diff --staged --quiet; then
            git commit -m "chore: update image tag and MAAS_REF to ${{ needs.prepare-release.outputs.version_tag }}"
            git push origin "${{ needs.prepare-release.outputs.minor_release_branch }}"
          else
            echo "No changes to commit on release branch"
          fi

  create-tag:
    name: Create Release Tag
    runs-on: ubuntu-latest
    needs: create-release-branch
    outputs:
      version_tag: ${{ needs.create-release-branch.outputs.version_tag }}
    
    steps:
      - name: Checkout release branch
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: ${{ needs.create-release-branch.outputs.minor_release_branch }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "${{ env.GH_USER_NAME }}"
          git config user.email "${{ env.GH_USER_EMAIL }}"

      - name: Create and push git tag
        run: |
          TAG="${{ needs.create-release-branch.outputs.version_tag }}"
          BRANCH="${{ needs.create-release-branch.outputs.minor_release_branch }}"
          
          # Check if tag already exists
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            if [ "${{ inputs.allow_tag_overwrite }}" != "true" ]; then
              echo "❌ Error: Tag $TAG already exists!"
              echo ""
              echo "Tags should be immutable once released. To overwrite an existing tag:"
              echo "1. Manually delete the tag if it was created by mistake:"
              echo "   git tag -d $TAG"
              echo "   git push origin :refs/tags/$TAG"
              echo "2. Re-run this workflow with 'Allow overwriting existing tag' enabled"
              echo ""
              echo "⚠️  Only enable tag overwrite for pre-release iterations, not for distributed tags!"
              exit 1
            else
              echo "⚠️  Warning: Overwriting existing tag $TAG (allow_tag_overwrite enabled)"
              echo "   This should only be used for pre-release iterations!"
              git tag -d "$TAG" || true
              git push origin ":refs/tags/$TAG" || true
            fi
          fi
          
          # Create annotated tag pointing to current commit on release branch
          git tag -a "$TAG" -m "Release $TAG"
          git push origin "$TAG"
          echo "Created tag $TAG from release branch $BRANCH"

      - name: Create GitHub Release
        if: inputs.create_release == true
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.create-release-branch.outputs.version_tag }}
          name: Release ${{ needs.create-release-branch.outputs.version_tag }}
          body: |
            This release updates the MaaS billing deployment manifests to use image tag `${{ needs.create-release-branch.outputs.version_tag }}`.
            
            ### Updated Files
            - `deployment/base/maas-api/kustomization.yaml`
            - `maas-api/deploy/overlays/dev/kustomization.yaml`
            - `maas-api/deploy/overlays/odh/params.env`
            - MAAS_REF references updated to use `${{ needs.create-release-branch.outputs.version_tag }}` instead of `main`
            
            ### Release Branch
            - Branch: `${{ needs.create-release-branch.outputs.minor_release_branch }}`
            
            > Note: Release notes can be edited after creation.
          draft: false
          prerelease: ${{ contains(inputs.tag, '-') || contains(inputs.tag, 'alpha') || contains(inputs.tag, 'beta') || contains(inputs.tag, 'rc') }}

  build-and-push-image:
    name: Build and Push Image
    runs-on: ubuntu-latest
    needs: [create-release-branch, create-tag]
    outputs:
      image_repo: ${{ steps.build_image.outputs.repo }}
    defaults:
      run:
        working-directory: maas-api
    
    steps:
      - name: Checkout release branch
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: ${{ needs.create-tag.outputs.version_tag }}

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version-file: maas-api/go.mod
          cache: true
          cache-dependency-path: maas-api/go.sum

      - name: Login to Quay.io
        uses: docker/login-action@v3
        with:
          registry: quay.io
          username: ${{ secrets.APP_QUAY_USERNAME }}
          password: ${{ secrets.APP_QUAY_TOKEN }}

      - name: Build and Push maas-api image to Quay.io
        id: build_image
        env:
          QUAY_REPO: ${{ secrets.APP_QUAY_REPO }}
        run: |
          if [ -n "$QUAY_REPO" ]; then
            echo "Using custom repository from secret: $QUAY_REPO"
            echo "repo=$QUAY_REPO" >> $GITHUB_OUTPUT
            make build-push-image REPO="$QUAY_REPO" TAG=${{ needs.create-tag.outputs.version_tag }} CONTAINER_ENGINE=docker
          else
            echo "Using Makefile default repository: quay.io/opendatahub/maas-api"
            echo "repo=quay.io/opendatahub/maas-api" >> $GITHUB_OUTPUT
            make build-push-image TAG=${{ needs.create-tag.outputs.version_tag }} CONTAINER_ENGINE=docker
          fi

  deploy-documentation:
    name: Deploy Documentation
    runs-on: ubuntu-latest
    needs: create-tag
    
    steps:
      - name: Checkout version tag
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          fetch-tags: true
          ref: ${{ needs.create-tag.outputs.version_tag }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('docs/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          pip install -r docs/requirements.txt

      - name: Configure Git
        run: |
          git config --global user.name "${{ env.GH_USER_NAME }}"
          git config --global user.email "${{ env.GH_USER_EMAIL }}"

      - name: Deploy versioned docs with mike
        run: |
          cd docs
          # Deploy the new version and update latest
          # Note: mike will automatically create the gh-pages branch if it doesn't exist
          mike deploy --push --update-aliases ${{ needs.create-tag.outputs.version_tag }} latest
          # Set latest as the default version
          mike set-default --push latest

  summary:
    name: Release Summary
    runs-on: ubuntu-latest
    needs: [prepare-release, create-release-branch, create-tag, build-and-push-image, deploy-documentation]
    if: always()
    
    steps:
      - name: Summary
        run: |
          {
            echo "## Release Summary"
            echo ""
            echo "✅ **Tag**: \`${{ needs.create-tag.outputs.version_tag }}\`"
            echo "✅ **Release Branch**: \`${{ needs.create-release-branch.outputs.minor_release_branch }}\`"
            echo "✅ **Git Tag**: Created and pushed from release branch"
            echo "✅ **Image Built & Pushed**: \`${{ needs.build-and-push-image.outputs.image_repo }}:${{ needs.create-tag.outputs.version_tag }}\`"
            echo "✅ **Documentation Deployed**: \`${{ needs.create-tag.outputs.version_tag }}\`"
            if [ "${{ inputs.create_release }}" == "true" ]; then
              echo "✅ **GitHub Release**: Created"
            fi
            echo ""
            echo "### Updated Files"
            echo "- \`deployment/base/maas-api/kustomization.yaml\`"
            echo "- \`maas-api/deploy/overlays/dev/kustomization.yaml\`"
            echo "- \`maas-api/deploy/overlays/odh/params.env\`"
            echo "- MAAS_REF references updated to use \`${{ needs.create-tag.outputs.version_tag }}\`"
            echo ""
            echo "### Documentation"
            echo "- Docs Version: \`${{ needs.create-tag.outputs.version_tag }}\`"
            echo "- Docs Alias: \`latest\`"
            echo "- Docs URL: https://opendatahub-io.github.io/models-as-a-service/"
          } >> "$GITHUB_STEP_SUMMARY"
